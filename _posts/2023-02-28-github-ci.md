---
layout: post
date: 2023-02-28 12:00:00 +00:00
title: Systemd Container and Podman in GitHub CI
description: How to run Systemd containers and/or Podman runtime on GitHub CI
permalink: blog/2023-02-28/systemd-podman-github-ci
tags:
- Programming
- Systemd
- D-Installer
- github-ci
- Podman
---

As D-Installer consists of several components like D-Bus backend, CLI or web frontend,
we see a need to test in CI that each component can start and communicate properly
with each other. For this we use a test framework and more importantly
GitHub CI where we need a systemd container which is not documented at all.
In the following paragraphs we would like to share with you how we did it so that
so that each of you can be inspired by it or use it for your own project.

## A Testing Container

Let us start with the container. We created a testing container in OBS that contains what is needed for
backend and frontend. During iterations we found that we depend on Network Manager and Network
Manager works really tight with systemd. For debugging we need the journal which also does not work without
systemd. So we end up creating a container that contains systemd.

Such container has some restrictions like that the first process must be systemd `init`. You can see
see our container at https://build.opensuse.org/package/show/YaST:Head:Containers/d-installer-testing

## GitHub CI

When asking uncle Google how to run such systemd container on GitHub CI it returns nothing relevant.
There was also hint to use Podman for such container due to its advanced support for it
( `--systemd` option which is true by default ). But for using Podman majority of answers suggest
self-hosting workers, which is not what we want to take care of.

Simply running the systemd container on GitHub CI does not work, as GitHub overwrites the entry point.
to `tail -f`, so systemd is not the first process. Then we notice that the GitHub hosted Ubuntu
VM also has Podman preinstalled. And the final idea of how to solve it appears and works for us.

## GitHub CI, Podman and Systemd Container

So idea is simple to run Podman as steps in GitHub CI and use our systemd container. We do not define the
container keyword at all and run it manually. Each step is encapsulated in `podman container exec`.

An example config might look like this:

```
  integration-tests:
    runs-on: ubuntu-latest

    steps:

    - name: Git Checkout
      uses: actions/checkout@v3

    - name: start container
      run: podman run --privileged --detach --name dinstaller --ipc=host -v .:/checkout registry.opensuse.org/yast/head/containers/containers_tumbleweed/opensuse/dinstaller-testing:latest

    - name: show journal
      run:  podman exec dinstaller journalctl -b
```

This simple snippet will checkout the GitHub repo, start the container, and then print the contents of the
journal. The important part is to set the name of the container so you can use it in the exec call. We also mount
inside container the git checkout so we can access it from there. Of course, real testing of container
is still ahead of you, but you already have a running systemd container and can inspect logs from it.
You can see the full configuration in action in the pull request https://github.com/yast/d-installer/pull/425

## Remaining Issues

For integration testing of dinstaller we still face some issues.

* *Different kernel*: on Ubuntu latest there is a different kernel and we face e.g. issue that device mapper
  kernel module is missing.
* *Restricted privileges*: Not all actions even in privileged container are possible, but it seems
  so far we are not much restricted. For example, we cannot manipulate host `/var/log`, so we cannot just mount
  host `/var/log` to container `/var/log` to easily recover logs to artifacts.
* *Cannot test the whole installation*: because the whole installation is long and we do not want to (and cannot)
  overwrite the host VM, we cannot do full end-to-end testing of the entire installation as part of each
  GitHub pull request. The good news is that SUSE/openSUSE has a great tool for testing
  the installation/running system called openQA and we are discussing how to integrate D-Installer with its
  test into it.
